<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>AIRBNB Dashboard</title>
        <!-- Libs -->
        <script src="./js/libs/d3.min.js" charset="utf-8"></script>
        <script src="./js/libs/topojson.v1.min.js"></script>
        <script src="./js/libs/crossfilter.min.js"></script>
        <script src="./js/libs/d3-legend.min.js"></script>
        <script src="./js/libs/d3.geo.tile.js"></script>
        <script src="./js/libs/dc.min.js"></script>

        <!-- Project files -->
        <script src="./js/map.js"></script>
        <script src="./js/calendar-heatmap.js"></script>
        <script src="./js/data-munging.js"></script>

        <link type="txt/css" rel="stylesheet" href="./css/dashboard-styles.css">

    </head>
    <body>
        <div id="airbnb-dashboard">
            <div class="chart-label">Airbnb Tahoe Market</div>
            <br/>
            <div id="loading">Loading ...</div>
            <div id="vis" style="display:none;">
                <div class="timeline">
                    <!-- @TODO -->
                </div>

                <div class="supply">
                    <div id="timeline-container">
                        <div class="chart-label">New Listings</div>
                    </div>

                    <div id="map-container" class="ib">
                        <div class="chart-label">Location</div>
                    </div>

                    <div class="dimensions">
                        <div id="people-capacity" class="ib">
                            <div class="chart-label">People capacity</div>
                        </div>
                        <div id="listing-type" class="ib">
                            <div class="chart-label">Type</div>
                        </div>
                        <div id="instant-bookable" class="ib">
                            <div class="chart-label">Book Instantly</div>
                        </div>
                    </div>
                </div>

                <div class="demand">
                    <div id="calendar-container">
                        <div class="chart-label">Demand</div>
                    </div>
                    <div class="dimensions">
                        <div id="number-of-nights" class="ib">
                            <div class="chart-label"># Nights</div>
                        </div>
                        <div id="number-of-guests" class="ib">
                            <div class="chart-label"># Guests</div>
                        </div>
                        <div id="origin-country" class="ib">
                            <div class="chart-label">Home Country</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <script>
            var overrideTimeDomain = [new Date("1/1/2013"), new Date("1/1/2015")];
            var map, byCapacity, byType, byInstant,
                calendar, byNights, byGuests, byCountry;

            initVis();

            function initVis() {
                // Fetch data
                d3.csv("../../data/listings.csv", function(error, listingsRaw) {
                    if (error) return console.error("listings error", error);

                    d3.csv("../../data/interactions.csv", function(error, interactionsRaw) {
                        var parsed = mungeData(listingsRaw, interactionsRaw);

                        d3.select("#loading").remove();
                        d3.select("#vis").style("display", "block");

                        makeVis(parsed);
                    });



                });
            }

            function makeVis(parsed) {
                var listings     = parsed.listings;
                var interactions = parsed.interactions;

                map = MapChart("#map-container")
                    .width(575)
                    .height(350)
                    .key(function(d) { return d.key; })
                    .location(function(d) { return d.key; })
                    .radius(function(d) { return +d.value; })

                d3.select("#map-container")
                    .datum(listings.groups.location.top(Infinity))
                    .call(map);

                byCapacity = dc.barChart("#people-capacity")
                    .width(200)
                    .height(150)
                    .margins({top: 10, right: 10, bottom: 20, left: 35})
                    .dimension(listings.dims.capacity)
                    .group(listings.groups.capacity)
                    .x( d3.scale
                          .linear()
                          .domain([0, 17]) )
                    .elasticY(true)
                    .gap(1)
                    .centerBar(true)
                    .round(function(v) { return dc.round.floor(v) + 0.5; })
                    .alwaysUseRounding(true)
                    .yAxisLabel('# listings')

                byType = dc.rowChart("#listing-type")
                    .width(150)
                    .height(150)
                    .margins({top: 10, right: 10, bottom: 20, left: 10})
                    .dimension(listings.dims.type)
                    .group(listings.groups.type)
                    .elasticX(true)
                    .xAxis().ticks(5);


                byInstant = dc.rowChart("#instant-bookable")
                    .width(75)
                    .height(150)
                    .margins({top: 10, right: 10, bottom: 20, left: 10})
                    .dimension(listings.dims.instantBookable)
                    .group(listings.groups.instantBookable)
                    .elasticX(true).on("filtered", function() {
                        map.updatePoints( listings.groups.location.top(Infinity) );
                    })
                    .xAxis().ticks(2)

                // Demand side
                calendar = $calendar = CalendarHeatmap("#calendar-container")
                    .dimension(interactions.dims.checkinDate)
                    .group(interactions.groups.checkinDate);

                calendar.redraw();

                byNights = dc.barChart("#number-of-nights")
                    .width(180)
                    .height(150)
                    .margins({top: 10, right: 10, bottom: 20, left: 50})
                    .dimension(interactions.dims.nights)
                    .group(interactions.groups.nights)
                    .x( d3.scale
                          .linear()
                          .domain([0, 20]) )
                    .elasticY(true)
                    .gap(1)
                    .centerBar(true)
                    .round(function(v) { return dc.round.floor(v) + 0.5; })
                    .alwaysUseRounding(true)
                    .yAxisLabel('# Interactions')
                    .on("filtered", function() {
                        console.log("on filtered")
                        calendar.redraw();
                    });

                byNights.xAxis().ticks(5)
                byNights.yAxis().ticks(4)

                byGuests = dc.barChart("#number-of-guests")
                    .width(180)
                    .height(150)
                    .margins({top: 10, right: 10, bottom: 20, left: 50})
                    .dimension(interactions.dims.guests)
                    .group(interactions.groups.guests)
                    .x( d3.scale
                          .linear()
                          .domain([0, 15]) )
                    .elasticY(true)
                    .gap(1)
                    .centerBar(true)
                    .round(function(v) { return dc.round.floor(v) + 0.5; })
                    .alwaysUseRounding(true)
                    .yAxisLabel('# Interactions')
                    .on("filtered", function() { calendar.redraw(); });

                byGuests.xAxis().ticks(5)
                byGuests.yAxis().ticks(4)

                byCountry = dc.rowChart("#origin-country")
                    .width(200)
                    .height(150)
                    .margins({top: 10, right: 10, bottom: 20, left: 10})
                    .dimension(interactions.dims.originCountry)
                    .group(interactions.groups.originCountry)
                    .elasticX(true)
                    .data(function(group) { return group.top(10); })
                    .on("filtered", function() { calendar.redraw(); });
                    // .x(d3.scale.log().nice().domain([1, 1000]).clamp(true))

                byCountry.xAxis()
                    .ticks(3)
                    .scale().domain([0,500]).clamp(true)

                dc.renderAll();
                makeTimeline(listings);

            };

            // Creates the event timeline and sets up callbacks for brush changes
            function makeTimeline(listings) {
                var data = listings.groups.dateCreated
                    .top(Infinity)
                    .sort(function(a,b) { return a.key - b.key; }) //listings.metrics.newListingsPerDay().top(Infinity); //listings.

                var margin = { top: 35, right: 15, bottom: 20, left: 25 },
                    width  = 575 - margin.left - margin.right,
                    height = 130 - margin.top  - margin.bottom;

                var timelineSvg = d3.select("#timeline-container").append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom);

                var timeline = timelineSvg.append("g")
                    .attr("class", "timeline")
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                var x = d3.time.scale()
                    .domain(overrideTimeDomain)
                    .range([0, width])
                    .clamp(true);

                var y = d3.scale.linear()
                    .domain([0, 20]) //d3.extent(data, function(d) { return +d.value; }))
                    .range([height, 0])
                    .clamp(true);

                var xAxis = d3.svg.axis()
                    .scale(x)
                    .orient("bottom");

                var yAxis = d3.svg.axis()
                    .scale(y)
                    .orient("left")
                    .ticks(2);

                var area = d3.svg.area()
                    .interpolate("linear")
                    .x(function(d) { return x(d.key); })
                    .y0(height)
                    .y1(function(d) { return y(d.value); });

                var dateRange = timelineSvg.append("g")
                    .attr("class", "timeline-range")
                    .attr("transform", "translate(" + (width + margin.left + margin.right) + ",10)")
                  .append("text")
                    .attr("text-anchor", "end");

                var listingCount = timelineSvg.append("g")
                    .attr("class", "listing-count")
                    .attr("transform", "translate(" + (width + margin.left + margin.right) + ",25)")
                  .append("text")
                    .attr("text-anchor", "end");

                timeline.append("path")
                    .datum(data)
                    .attr("class", "area")
                    .attr("d", area);

                timeline.append("g")
                    .attr("class", "x axis")
                    .attr("transform", "translate(0," + height + ")")
                    .call(xAxis);

                timeline.append("g")
                    .attr("class", "y axis")
                    .call(yAxis);

                timeline.append("text")
                    .attr("transform", "rotate(-90)")
                    .attr("dy", "1em")
                    .style("text-anchor", "end")
                    .text("New listings");

                // Add brush to timeline, hook up to callback
                var brush = d3.svg.brush()
                    .x(x)
                    .on("brush", function() {
                        var extent = brush.extent().map(d3.time.day.round); // snap to days
                        listings.dims.dateCreated.filter(extent)
                        dateRange.text(formatDateRange(extent));
                        listingCount.text(getListingsCount(listings, extent))
                        redrawAll(listings);
                    })
                    .extent([new Date("12/1/2014"), new Date("1/1/2015")]); // initial value

                timeline.append("g")
                    .attr("class", "x brush")
                    .call(brush)
                  .selectAll("rect")
                    .attr("y", -6)
                    .attr("height", height + 7);

                brush.event(timeline.select('g.x.brush')); // dispatches a single brush event

                function formatDateRange(range) {
                    var format = d3.time.format("%a %b %d %Y");
                    return format(range[0]) + " - " + format(range[1]);
                };
                function getListingsCount(listings, extent) {
                    return listings.dims.location.top(Infinity).length + " new listings";
                };
            };

        function redrawAll(listings) {
            map.updatePoints( listings.groups.location.top(Infinity) );
            calendar.redraw();
            dc.redrawAll();
        };
        </script>
    </body>
</html>
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>AIRBNB Dashboard</title>
        <!-- Libs -->
        <script src="./js/libs/d3.min.js" charset="utf-8"></script>
        <script src="./js/libs/topojson.v1.min.js"></script>
        <script src="./js/libs/crossfilter.min.js"></script>
        <script src="./js/libs/d3-legend.min.js"></script>
        <script src="./js/libs/d3.geo.tile.js"></script>
        <script src="./js/libs/dc.min.js"></script>

        <!-- Project files -->
        <script src="./js/map.js"></script>
        <script src="./js/calendar-heatmap.js"></script>
        <script src="./js/reusable-linechart.js"></script>
        <script src="./js/parse-data.js"></script>

        <link type="txt/css" rel="stylesheet" href="./css/dashboard-styles.css">
        <link type="txt/css" rel="stylesheet" href="./css/reusable-linechart.css">

    </head>
    <body>
        <div id="airbnb-dashboard">
            <div class="chart-label">Airbnb Tahoe Market</div>
            <br/>
            <div id="loading">Loading ...</div>
            <div id="vis" style="display:none;">
                <div class="hero">
                    <div id="timeline">
                        <div class="date-summary"></div>
                        <div class="zoom"></div>
                    </div>
                </div>

                <div class="supply">
                    <div id="timeline-container">
                        <div class="chart-label">New Listings</div>
                    </div>

                    <div id="map-container" class="ib">
                        <div class="chart-label">Location</div>
                    </div>

                    <div class="dimensions">
                        <div id="people-capacity" class="ib">
                            <div class="chart-label">People capacity</div>
                        </div>
                        <div id="listing-type" class="ib">
                            <div class="chart-label">Type</div>
                        </div>
                        <div id="instant-bookable" class="ib">
                            <div class="chart-label">Book Instantly</div>
                        </div>
                    </div>
                </div>

                <div class="demand">
                    <div id="calendar-container">
                        <div class="chart-label">Demand</div>
                    </div>
                    <div class="dimensions">
                        <div id="number-of-nights" class="ib">
                            <div class="chart-label"># Nights</div>
                        </div>
                        <div id="number-of-guests" class="ib">
                            <div class="chart-label"># Guests</div>
                        </div>
                        <div id="time-to-reply" class="ib">
                            <div class="chart-label">Response time</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <script>
            var listingsColor     = "#4dac26";
            var interactionsColor = "#d01c8b";
            var overrideTimeDomain = [new Date("1/1/2013"), new Date("1/1/2015")];
            var initialTimerange   = [new Date("12/1/2014"), new Date("1/1/2015")];
            var map, byCapacity, byType, byInstant,
                calendar, byNights, byGuests, timeToReply;

            initVis();

            function initVis() {
                // Fetch data
                d3.csv("../../data/listings.csv", function(error, listingsRaw) {
                    if (error) return console.error("listings error", error);

                    d3.csv("../../data/interactions.csv", function(error, interactionsRaw) {
                        var parsed = mungeData(listingsRaw, interactionsRaw);

                        d3.select("#loading").remove();
                        d3.select("#vis").style("display", "block");

                        makeVis(parsed);
                    });



                });
            }

            function makeVis(parsed) {
                var listings     = parsed.listings;
                var interactions = parsed.interactions;

                map = MapChart("#map-container")
                    .width(575)
                    .height(350)
                    .key(function(d) { return d.key; })
                    .location(function(d) { return d.key; })
                    .radius(function(d) { return +d.value; })

                // d3.select("#map-container")
                //     .datum(listings.groups.location.top(Infinity))
                //     .call(map);

                byCapacity = dc.barChart("#people-capacity")
                    .width(200)
                    .height(150)
                    .margins({top: 10, right: 10, bottom: 20, left: 35})
                    .dimension(listings.dims.capacity)
                    .group(listings.groups.capacity)
                    .x( d3.scale
                          .linear()
                          .domain([0, 17]) )
                    .elasticY(true)
                    .gap(1)
                    .centerBar(true)
                    .round(function(v) { return dc.round.floor(v) + 0.5; })
                    .alwaysUseRounding(true)
                    .yAxisLabel('# listings')

                byType = dc.rowChart("#listing-type")
                    .width(150)
                    .height(150)
                    .margins({top: 10, right: 10, bottom: 20, left: 10})
                    .dimension(listings.dims.type)
                    .group(listings.groups.type)
                    .elasticX(true)
                    .xAxis().ticks(3);


                byInstant = dc.rowChart("#instant-bookable")
                    .width(75)
                    .height(150)
                    .margins({top: 10, right: 10, bottom: 20, left: 10})
                    .dimension(listings.dims.instantBookable)
                    .group(listings.groups.instantBookable)
                    .elasticX(true).on("filtered", function() {
                        map.updatePoints( listings.groups.location.top(Infinity) );
                    })
                    .xAxis().ticks(2)

                // Demand side
                calendar = $calendar = CalendarHeatmap("#calendar-container")
                    .dimension(interactions.dims.checkinDate)
                    .group(interactions.groups.checkinDate);

                calendar.redraw();

                byNights = dc.barChart("#number-of-nights")
                    .width(180)
                    .height(150)
                    .margins({top: 10, right: 10, bottom: 20, left: 50})
                    .dimension(interactions.dims.nights)
                    .group(interactions.groups.nights)
                    .x( d3.scale
                          .linear()
                          .domain([0, 20]) )
                    .elasticY(true)
                    .gap(1)
                    .centerBar(true)
                    .round(function(v) { return dc.round.floor(v) + 0.5; })
                    .alwaysUseRounding(true)
                    .yAxisLabel('# Interactions')
                    .on("filtered", function() {
                        console.log("on filtered")
                        calendar.redraw();
                    });

                byNights.xAxis().ticks(5)
                byNights.yAxis().ticks(4)

                byGuests = dc.barChart("#number-of-guests")
                    .width(180)
                    .height(150)
                    .margins({top: 10, right: 10, bottom: 20, left: 50})
                    .dimension(interactions.dims.guests)
                    .group(interactions.groups.guests)
                    .x( d3.scale
                          .linear()
                          .domain([0, 15]) )
                    .elasticY(true)
                    .gap(1)
                    .centerBar(true)
                    .round(function(v) { return dc.round.floor(v) + 0.5; })
                    .alwaysUseRounding(true)
                    .yAxisLabel('# Interactions')
                    .on("filtered", function() { calendar.redraw(); });

                byGuests.xAxis().ticks(5)
                byGuests.yAxis().ticks(4)

                timeToReply = dc.rowChart("#time-to-reply")
                    .width(200)
                    .height(150)
                    .margins({top: 10, right: 10, bottom: 20, left: 10})
                    .dimension(interactions.dims.timeToReply)
                    .group(interactions.groups.timeToReply)
                    .elasticX(true)
                    .data(function(group) { return group.top(10); })
                    .on("filtered", function() { calendar.redraw(); })
                    .xAxis().ticks(5)

                dc.renderAll();

                makeTimeline(listings, interactions);
            };

            // Creates the event timeline and sets up callbacks for brush changes
            function makeTimeline(listings, interactions) {
                var isZoomed = false;
                var data = formatDataForTimeline(listings, interactions);
                var filteredData; // on zoom

                var container    = d3.select("#timeline");
                var dateRange    = d3.select("#timeline .date-summary");
                // var countSummary = d3.select("#timeline .counts-summary");
                var zoomToggle = d3.select("#timeline .zoom")
                    .on("click", zoomOrResetTimeline);

                var timeline = fancyLineChart('#timeline')
                    .width(575)
                    .height(100)
                    .xAccessor(function(d) { return +d.key})
                    .yAccessor(function(d) { return +d.value })
                    .y2Accessor(function(d) { return +d.value })
                    .axisY({ title: "# Listings", titleClass: "y-label listings-color" })
                    .axisY2({ title: "# Interactions", titleClass: "y-label interactions-color" })
                    .radiusAccessor(function(d) { return 0; })
                    .onBrushed(onBrush);

                timeline.xAxis().ticks(5);
                timeline.yAxis().ticks(5);
                timeline.y2Axis().ticks(5);

                d3.select("#timeline")
                    .datum(data)
                    .call(timeline);

                timeline.brush().extent(initialTimerange);
                timeline.svg.select(".brush").call(timeline.brush());
                onBrush();

                function onBrush(brush, brushG) {
                    brush = brush || timeline.brush();
                    var extent = brush.extent().map(d3.time.day.round); // snap to days

                    listings.dims.dateCreated.filter(extent)
                    interactions.dims.firstInteraction.filter(extent);

                    dateRange.html(formatDateRange(extent, brush.empty()));
                    // listingCount.text(getListingsCount(listings, extent))
                    redrawAll(listings);

                    if (brush.empty()) {
                        zoomToggle.html("");
                        timeline.updateChart(data);
                    } else {
                        zoomToggle.html("Zoom");
                    }
                }

                // Formats for reusable linechart { name: string, values: [object] }
                function formatDataForTimeline(listings, interactions) {
                    var listingsGroup = listings.groups.dateCreated
                        .top(Infinity)
                        .sort(function(a,b) { return a.key - b.key; });

                    var listingsData = {
                        name: "new listings",
                        color: listingsColor,
                        axis: 0,
                        values: listingsGroup.filter(function(d) {
                            return d.key >= overrideTimeDomain[0] && d.key <= overrideTimeDomain[1];
                        })
                    };

                    var interactionsGroup = interactions.groups.firstInteraction
                        .top(Infinity)
                        .sort(function(a,b) { return a.key - b.key; });

                    var interactionsData = {
                        name: "interactions",
                        color: interactionsColor,
                        axis: 1,
                        values: interactionsGroup.filter(function(d) {
                            return d.key >= overrideTimeDomain[0] && d.key <= overrideTimeDomain[1];
                        })
                    };

                    var data = [listingsData, interactionsData];
                    console.log(data);
                    return data;
                };

                function zoomOrResetTimeline() {
                    var brush = timeline.brush();
                    filterToTimeRange(brush.extent());

                    timeline.svg.select(".brush")
                        .call(brush.clear());
                };

                function filterToTimeRange(extent) {
                    filteredData = [];

                    data.forEach(function(group) {
                        var values = group.values.filter(function(d) {
                            return d.key >= extent[0] && d.key <= extent[1];
                        });
                        filteredData.push(Object.assign({}, group, { values }));
                    });

                    timeline.updateChart(filteredData);
                };

                function formatDateRange(range, isEmpty) {
                    if (isEmpty) {
                        return "Select time range";
                    }
                    var format = d3.time.format("%a %b %d %Y");
                    return "Showing data for <span class='emph'>" + format(range[0]) +
                           "</span> &ndash; <span class='emph'>" + format(range[1]) + "</span>";
                };

                function getListingsCount(listings, extent) {
                    return listings.dims.location.top(Infinity).length + " new listings";
                };

                function getInteractionsCount(interactions, extent) {};
            };

        function redrawAll(listings) {
            // map.updatePoints( listings.groups.location.top(Infinity) );
            calendar.redraw();
            dc.redrawAll();
        };
        </script>
    </body>
</html>